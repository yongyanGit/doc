#### HTTP协议

#### 1. HTTP 请求的准备

当我们在浏览器中输入一个URL时，浏览器会将这个域名发送给DNS服务器，然后DNS服务器将它解析成IP地址。然后由于HTTP是基于TCP协议的，所以首先要先建立TCP连接，进行三次握手，并且目前使用的HTTP协议大部分都是1.1，在1.1的协议里面，默认开启Keep-Alive的，这样建立的TCP连接就可以在多次的请求中复用。

#### 2. HTTP 请求的构建

请求格式如下：

![http](../images/net/httprequet.jpg)

HTTP的报文大概分为三大部分。第一部分是请求行，第二部分是请求的首部，第三部分才是请求的正文实体。

#### 第一部分请求行

在请求行中，URL就是请求地址如：```http://www.baidu.com```，版本是HTTP 1.1。

对于方法，我们常用的有如： GET，就是去服务器获取资源；POST，主动告诉服务器一些信息，例如我们在网站注册用户时，主动添加个人信息；PUT：就是向指定资源位置上传最新内容，它与POST基本相同，但是在实际应用中，PUT往往用来修改一个资源。还有DELETE，用来删除资源。

#### 第二部分：首部字段

请求行下面就是首部字段，首部是key value，通过冒号分割。

请求首部字段：

1. Accept：告诉WEB服务器，用户代理能够处理的媒体类型，以及媒体类型的相对优先级。```*/*```表示任何类型 (text/html)。
2. Accept-Charset：告诉服务器用户代理支持的字符集，以及字符集的相对优先级，可用q值来表示相对优先级，q的范围是0~1，默认q=1.0 比如：gb2312,utf-8;q=0.7,*;q=0.7。

3. Accept-Encoding：告诉服务器用户代理支持的内容编码，通常指定压缩方法(gzip, deflate)。

4. Accept-Language：用来告诉服务器用户代理能够处理的自然语言集,比如：zh-CN,zh;q=0.8,zh-TW;q=0.7,zh-HK;q=0.5,en-US;q=0.3,en;q=0.2。

5. Authorization：用来告诉服务器，用户代理的认证信息。
6. Host：请求的web服务器域名地址。当请求被发送到服务器时，请求中的主机名会用IP地址直接替换解决。但如果相同的IP地址下部署运行着多个域名，那么服务器就无法理解究竟哪个域名对应的请求。因此就需要使用首部字段Host来明确指出请求的主机名称。
7. If-Match：形如if-xxx这种样式的请求首部字段，都可称为条件请求。服务器接收到附带条件的请求后，只有判断指定条件为真，才会执行请求。首部字段If-Match它会高速服务器匹配资源所用的实体标记(ETag)值。这时的服务器无法使用弱ETag值。服务器会对比If-Match字段值和资源的ETag值，仅当两者一致时，才会执行请求。还可以使用星号(*)指定If-Match值，服务器将会忽略Etag的值，只要资源存在就处理请求。
8. If-Modified-Since：如果在If-Modified-Since字段指定的日期时间之后，资源发生了更新，服务器会接受请求。如果请求的资源没有更新，则返回状态码304Not Modified的响应。获取资源的更新日期时间可以通过Last-Modified来确定。
9. If-None-Match：它的段值与ETag值不一致时，可以处理该请求。与If-Match首部字段的作用相反。
10. If-Range：浏览器告诉WEB服务器，如果我请求的对象没有发生改变，就把我缺少的部分给我，如果对象改变了，就把整个对象给我。浏览器通过发生请求对象的ETag或者自己所知道的最后修改时间给WEB服务器，让其判断对象是否改变了。
11. If-Unmodified-Since：与首部字段If-Modified-Since的作用相反。
12. Max-Forwards：通过TRACE方法或OPTIONS方法，发送包含首部字段Max-Forwards的请求时，该字段以十进制整形的形式指定可经过的服务器最大数目。服务器在往下一个服务器转发之前，Max-Forwards的值减一后重新赋值。当服务器接收到Max-Forwards值为0的请求时，则不再进行转发，而是直接返回。



响应首部字段：

1. ETag：首部字段ETag能告诉客户端实体标识。它是一种可将资源以字符串形式做唯一标识的方式。服务器会为每份资源分配对应的ETag。当资源更新时，ETag值也需要更新。

Etag中有强ETag值和弱Tag值之分：

强ETag：不论实体发生多么细微的变化都会改变它的值。

弱ETag：只用于提示资源是否相同。只有资源发生根本改变，产生差异时才会改变Etag值。

2. Accept-Range用来告知客户端，服务端是否能处理范围请求，以指定获取服务端某个部分的资源。可以指定的字段值有两种，可处理范围请求时指定其为bytes，反之则指定其为none。
3. age：告知客户端，源服务器在多久前创建了响应。字段值的单位为秒。若创建该响应的服务器是缓存服务器，Age值是指缓存后的响应再次发起认证到认证完成的时间值。
4. Location：可以将响应接收方引导至某个与请求URI位置不同的资源。基本上该字段会配合3xx：Redirection的响应，提供重定向URI。
5. Retry-After：告知客户端应该在多久之后再次发送请求。
6. Server：首部字段Server告知客户端当前服务器上安装的HTTP服务器应用程序的信息。
7. Vary：首部字段Vary可对缓存进行控制。从代理服务器接收到源服务器返回包含Vary指定项的响应之后，并进行缓存，然后接收到客户端请求，仅对包含有相同Vary指定首部字段的请求返回缓存。如果Vary指定的首部字段不相同，必须从源服务器重新获取资源。

实体首部字段：

1. Allow：用于通知客户端能够支持Request-URI指定资源的所有HTTP方法。当服务器接收到不支持的HTTP方法时，会以状态码405Not Allowed作为响应返回。与此同时，还会把所有能支持的HTTP方法写入首部字段Allow后返回。

2. Content-Encoding：告诉客户端服务器对实体的主体部分选用的内容编码方式。内容编码是指在不丢失实体信息的前提下所进行的压缩(gzip)。

3. Content-Language：告诉客户端，实体主体使用的自然语言。

4. Content-Length：实体主体部分的大小(单位是字节)。对实体主体进行内容编码时，不能使用Content-Length首部字段。

5. Content-Location：给出与报文主体部分相对应的URI。

6. Content-Range：针对范围请求，返回响应时使用首部字段Content-Range，能告知客户端返回符合范围的哪个部分。字段值以字节为单位，表示当前发送部分以及整个实体大小。

7. Content-Type：说明了实体主体内对象的媒体类型。和首部字段Accept一样。

8. Expires：首部字段Expires会将资源失效日期告知客户端。缓存服务器在接到含有首部字段Expires的响应后，会以缓存来应答请求，在Expires字段值指定的时间之前，响应的副本会一直被保存。当超过指定的时间后，缓存服务器在请求发送过来时，会转向源服务器请求资源。

9. Last-Modified：首部字段Last-Modified指明资源最终修改时间。

   

