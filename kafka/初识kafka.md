### 初识kafka

1. 消息和批次

Kafka的数据单元称为消息，可以把消息看成数据库里的一个“数据行”或一条记录。消息没有特别的格式或含义。但是它有一个可选的元数据，也就是键，当消息以一种可控的方式写入不同的分区时，会用到键。最简单的方式就是为键生成一个一致性散列值，然后使用散列值对主题分区数进行取模，为消息选取分区。

批次就是一组消息，这些消息同属于一个主题和分区，如果一个消息都单独穿行于网络，会导致大量的网络开销，把消息分成批次传递可以减少网络开销。但是批次越大，单位时间内处理的消息就越多，单个消息的传输时间就越长。

2. 模式


对于Kafka来说，消息不过是字节数组，所以有人建议用一些额外的结构来定义消息内容，让它们更容易理解。根据应用程序的需求，消息模式有许多可用选项。像JSON和XML，不仅易用，而且可读性好。

3. 主题和分区

Kafka消息通过主题进行分类，主题就好比数据库的表。主题可以分为若干个分区，一个分区就是一个提交日志。消息以追加的方式写入分区，然后以先入先出的顺序读取。要注意一个主题一般包含几个分区，因此无法在整个主题范围内保证消息的顺序，但可以保证消息在单个分区内的顺序。

![fenqu](../images/kafka/fenqu.png)

4. 生成者和消费者

* 生产者

生产者创建消息。默认情况下，消息被均衡地分布到主题的所有的分区上。不过在某些情况下，生产者通过消息键和分区器来将消息写到指定的分区。

* 消费者

消费者读取消息。消费者可以订阅一个或者多个主题，然后通过消息偏移量来区分已经读取过的消息。偏移量是一个不断递增的整数值，在创建消息时，Kafka会把它添加到消息里。在给定的分区里，每个消息的偏移量都是唯一的。

消费者是消费者群组的一部分，也就是说会有一个或者多个消费者共同读取一个主题。群组保证每个分区只能被一个消费者使用。而且，如果一个消费者失效，群组里的其它消费者可以接管失效消费者的工作。

![consumer](../images/kafka/consumer3.png)

5. broker和集群

一个独立的kafka服务器被称为broker。broker接收来自生产者的消息，为消息设置偏移量，并提交消息到磁盘保存。broker为消费者提供服务，对读区分区的请求作出响应，返回已经提交到磁盘上的消息。

broker是集群的组成部分。每个集群都有一个broker同时充当了集群控制器的角色，控制器负责管理工作，包括将分区分配给broker和监控broker。

一个分区从属于一个broker，该broker被称为分区的首领。一个分区可以分配给多个broker，这个时候会发生复制。这种机制为分区提供消息冗余，如果有一个broker失效，其它broker可以接管领导权。

![broker](../images/kafka/broker.png)

