# JAVA 类文件结构

 ## 1. 类文件的整体结构



Java文件经过编译后，以16进制的形，严格按照JVM定义的规范，存放在class文件中。一个完整的类文件包含有魔数、java版本信息、常量池、父类、接口、方法、成员变量等信息。如下图构成类文件的数据项：

class文件格式：

| 类型           | 名称                | 数量                  |
| -------------- | ------------------- | --------------------- |
| u4             | magic               | 1                     |
| u2             | minor_version       | 1                     |
| u2             | major_version       | 1                     |
| u2             | constant_pool_count | 1                     |
| cp_info        | constant_pool       | constant_pool_count-1 |
| u2             | access_flags        | 1                     |
| u2             | this_class          | 1                     |
| u2             | super_class         | 1                     |
| u2             | interfaces_count    | 1                     |
| u2             | interfaces          | interfaces_count      |
| u2             | fields_count        | 1                     |
| field_info     | fields              | field_count           |
| u2             | methods_count       | 1                     |
| method_info    | methods             | methods_count         |
| u2             | attributes_count    | 1                     |
| attribute_info | attributes          | attributes_count      |

* **类型**叫做**无符号数**，它是一种基本数据类型，以u1、u2、u4、u8分别代表1个字节、2个字节、4个字节、8个字节。它用来记录数据项在class文件中占用多少个字节。如：magic对应的类型u4，表示在class文件中占用4个字节(即文件的开头4个字节就是magic的内容)。
* 在class文件中，当同一类型的数据项有多个时，会前置一个容量计数器来表示数据项的个数，然后在该计数器的后面连续排列具体的数据项。如constant_pool(常量池)就是一个相同数据项的集合，在它前面有constant_pool_count来表示常量池的大小。
* 每个类文件都是严格按照上述表格形式、顺序来存放编译后的数据的。




下面就一一来解释类文件中的各个数据项。

示例代码：

```
public class TestClass {
	
	private int m;
	
	public int inc(){
		return m+1;
	}

}
```

编译后的字节码

 ```
cafe babe 0000 0034 0033 0700 0201 0017
7a6f 6f6b 6565 7065 7264 656d 6f2f 5465
7374 436c 6173 7307 0004 0100 106a 6176
612f 6c61 6e67 2f4f 626a 6563 7401 0001
6d01 0001 4901 0006 3c69 6e69 743e 0100
0328 2956 0100 0443 6f64 650a 0003 000b
0c00 0700 0801 000f 4c69 6e65 4e75 6d62
6572 5461 626c 6501 0012 4c6f 6361 6c56
6172 6961 626c 6554 6162 6c65 0100 0474
6869 7301 0019 4c7a 6f6f 6b65 6570 6572
6465 6d6f 2f54 6573 7443 6c61 7373 3b01
0003 696e 6301 0003 2829 4909 0001 0013
0c00 0500 0601 0004 6d61 696e 0100 1628
5b4c 6a61 7661 2f6c 616e 672f 5374 7269
6e67 3b29 560a 0001 000b 0900 1800 1a07
0019 0100 106a 6176 612f 6c61 6e67 2f53
7973 7465 6d0c 001b 001c 0100 036f 7574
0100 154c 6a61 7661 2f69 6f2f 5072 696e
7453 7472 6561 6d3b 0a00 0100 1e0c 001f
0011 0100 0469 6e63 320a 0021 0023 0700
2201 0013 6a61 7661 2f69 6f2f 5072 696e
7453 7472 6561 6d0c 0024 0025 0100 0770
7269 6e74 6c6e 0100 0428 4929 5601 0004
6172 6773 0100 135b 4c6a 6176 612f 6c61
6e67 2f53 7472 696e 673b 0100 0663 6c61
7373 3107 002a 0100 136a 6176 612f 6c61
6e67 2f45 7863 6570 7469 6f6e 0100 0178
0100 0165 0100 154c 6a61 7661 2f6c 616e
672f 4578 6365 7074 696f 6e3b 0100 0d53
7461 636b 4d61 7054 6162 6c65 0700 3001
0013 6a61 7661 2f6c 616e 672f 5468 726f
7761 626c 6501 000a 536f 7572 6365 4669
6c65 0100 0e54 6573 7443 6c61 7373 2e6a
6176 6100 2100 0100 0300 0000 0100 0200
0500 0600 0000 0400 0100 0700 0800 0100
0900 0000 2f00 0100 0100 0000 052a b700
0ab1 0000 0002 000c 0000 0006 0001 0000
0003 000d 0000 000c 0001 0000 0005 000e
000f 0000 0002 0010 0011 0001 0009 0000
0031 0002 0001 0000 0007 2ab4 0012 0460
ac00 0000 0200 0c00 0000 0600 0100 0000
0800 0d00 0000 0c00 0100 0000 0700 0e00
0f00 0000 0900 1400 1500 0100 0900 0000
4f00 0200 0200 0000 13bb 0001 59b7 0016
4cb2 0017 2bb6 001d b600 20b1 0000 0002
000c 0000 000e 0003 0000 000d 0008 000e
0012 0010 000d 0000 0016 0002 0000 0013
0026 0027 0000 0008 000b 0028 000f 0001
0001 001f 0011 0001 0009 0000 00c0 0001
0005 0000 001a 043c 1b36 0406 3c15 04ac
4d05 3c1b 3604 063c 1504 ac4e 063c 2dbf
0003 0000 0005 000a 0029 0000 0005 0015
0000 000a 0010 0015 0000 0003 000c 0000
0032 000c 0000 0018 0002 001a 0005 0020
0007 001a 000a 001c 000b 001d 000d 001e
0010 0020 0012 001e 0015 001f 0016 0020
0018 0021 000d 0000 0034 0005 0000 001a
000e 000f 0000 0002 0008 002b 0006 0001
000d 0008 002b 0006 0001 0018 0002 002b
0006 0001 000b 000a 002c 002d 0002 002e
0000 000a 0002 4a07 0029 4a07 002f 0001
0031 0000 0002 0032 
 ```




## 2. magic和class文件版本

每个文件的开头4个字节称为魔数。它唯一的作用是确定这个文件是否是虚拟机能够接受的class文件。很多文件存储标准中也是使用魔数来进行身份验证，如：jpeg或者gif的文件头中也存在魔数。使用魔数而不是通过扩展名来验证文件类型是处于安全考虑，因为文件扩展名是可以更改的。class文件中的魔数是：0xCAFEBABE(咖啡宝贝?)

紧接着魔数后的第5、6个字节是次版本，第7、8个字节是主版本。JDK可以向下兼容版本，但不能运行超过它超过它版本号的class文件。如：上述的字节码JDK1.8环境下编译的，主版本号是：0x0034，转换成10进制后就是52，而JDK1.7可以生成的最高版本号是51,所以如果将该字节码放在1.7的JDK上，虚拟机将拒接执行。

## 3. 常量池

紧接着主次版本后面就是常量池入口，常量池主要存放两大类常量：字面量和符号引用。字面量比较接近于JAVA中的常量概念，如：字符串、final的常量值。而符号引用包括下面三类常量：

* 类和接口的全限名称(含有包名的类或者接口名称)
* 字段的名称和描述符
* 方法的名称和描述符































