### 高性能索引



#### 独立的列

独立的列是指索引列不能是表达式的一部分，也不能是函数的参数。

> 试验数据来自sakila-db压缩包

```
explain select * from actor where  actor_id=166\G;
```

执行结果:

```
*************************** 1. row ***************************
           id: 1
  select_type: SIMPLE
        table: actor
         type: const
possible_keys: PRIMARY
          key: PRIMARY
      key_len: 2
          ref: const
         rows: 1
        Extra: NULL
```

从执行结果可以看出查询优化器使用了主键索引。

如果我们将查询条件改成一个表达式，那么将不会使用索引。

```
 explain select * from actor where  actor_id + 1=166\G;
```

执行结果：

```
*************************** 1. row ***************************
           id: 1
  select_type: SIMPLE
        table: actor
         type: ALL
possible_keys: NULL
          key: NULL
      key_len: NULL
          ref: NULL
         rows: 200
        Extra: Using where
```

#### 前缀索引

有时候需要加索引的列的字符串很长，当为它加索引后，会使得索引空间变得大，索引效率低。这个时候可以截取该列数据的前缀来建索引。创建前缀索引既要保证选择的字符串不能太长而且它的选择性要高。



**创建前缀索引**

创建测试数据

```
create table city_demo (city varchar(50) not null);
insert into city_demo(city) select city from city;
update city_demo set city = (select city from city order by rand() limit 1);
```

先查询出最频繁出现的城市以及次数

```
select count(*) AS cnt ,city from city_demo group by city order by cnt desc limit 10;
```

```
+-----+-----------+
| cnt | city      |
+-----+-----------+
|  13 | Cuauhtmoc |
|  13 | Rizhao    |
|  13 | Oulu      |
|  11 | Shivapuri |
|  11 | Sivas     |
|  11 | Cianjur   |
|  11 | Dzerzinsk |
|  11 | Serpuhov  |
|  11 | Matamoros |
|  11 | Laohekou  |
+-----+-----------+
```

上面城市出现的的次数在11 ~13之间，然后查找最频繁出现的城市前缀，先从3个前缀字母开始：

```
select count(*) as cnt,left(city,3) as pref from city_demo group by pref order by cnt desc limit 10;
```

查询结果：

```
+-----+------+
| cnt | pref |
+-----+------+
|  69 | San  |
|  32 | Sou  |
|  32 | Tan  |
|  29 | Cha  |
|  29 | Kam  |
|  25 | Shi  |
|  25 | al-  |
|  24 | Man  |
|  22 | Sal  |
|  22 | Ben  |
+-----+------+
```

然后依次增加前缀的长度，直到前缀长度为7时，这个前缀的选择性与完整列的选择性差不多，所以前缀的长度为7比较合适。

```
+-----+---------+
| cnt | pref    |
+-----+---------+
|  16 | Santiag |
|  13 | Rizhao  |
|  13 | Cuauhtm |
|  13 | Oulu    |
|  11 | Laoheko |
|  11 | Dzerzin |
|  11 | Matamor |
|  11 | Shivapu |
|  11 | Serpuho |
|  11 | Cianjur
```

创建索引sql

```
alter table city_demo add key (city(7));
```

注意：

无法使用前缀索引做group by 和order by。

```
explain select * from city_demo order by city\G;
```

```
*************************** 1. row ***************************
           id: 1
  select_type: SIMPLE
        table: city_demo
         type: ALL
possible_keys: NULL
          key: NULL
      key_len: NULL
          ref: NULL
         rows: 3000
        Extra: Using filesort
```



#### 多列索引



